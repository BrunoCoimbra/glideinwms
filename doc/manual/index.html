<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<head>
	<meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
	<TITLE>Glidein based WMS</TITLE>
	<meta name="CREATED" content="0;0">
	<META NAME="CHANGED" CONTENT="20090513;15530100">
	<META NAME="CHANGEDBY" CONTENT="Igor Sfiligoi">
	<link rel="stylesheet" type="text/css" href="glideinWMS.css" media="screen, projection" />
</head>

<body lang="en-US" dir="ltr">
    <h1>
        <a href="index.html">Glidein WMS  Manual</a>
        <ul class="main_links">
        <li><a href="http://www.uscms.org/SoftwareComputing/Grid/WMS/glideinWMS/
index.html" class="main_link">Home</a></li>
        <li><a href="http://www.uscms.org/SoftwareComputing/Grid/WMS/glideinWMS/
doc.prd/install/" class="main_link">Installation</a></li>
        <li><a href="http://www.uscms.org/SoftwareComputing/Grid/WMS/glideinWMS/
doc.prd/manual/" class="main_link">Manual</a></li>
        <li><a href="http://www.uscms.org/SoftwareComputing/Grid/WMS/glideinWMS/
download.html" class="main_link">Download</a></li>
        </ul>

    </h1>

    <ul class="components">
        <li> <a href="index.html"> Overview </a></li>
        <li> <a href="factory/index.html"> Factory </a></li>
        <li> <a href="frontend/index.html"> VO Frontend </a></li>
        <li> <a href="monitoring.html" class="last">Monitoring</a></li>
    </ul>
    <div class="clear" />
    <ul class="topnav">
	<li><a href="#introduction">Introduction</a> </li>
	<li><a href="#glideins">The Glidein Mechanism</a> </li>
	<li><a href="#overview">WMS Overview</a> </li>
	<li><a href="#classads">Data Exchange Overview</a> </li>
	<li><a href="#implementation">Implementation Details</a> </li>
	<li><a href="#condor">The Condor Pool</a> </li>
    </ul>

<div class="content">
	<H2 class="header">Overview</H2>

<P>The glideinWMS package holds the Condor glidein based Workload
Management System (WMS).</P>


<div class="section">
<H2><A NAME="introduction"></A>Introduction</H2>
<p>
This document describes the glidein based WMS and its architecture in details.
Most of the components of glideinWMS described in this manual can be installed
by the installation tool provided with the glideinWMS. Please refer to the 
<a href="../install/index.html">installation guide for more details</a>.
</p>
</div>

<div class="section">
<H2><A NAME="glideins"></A>The Glidein Mechanism</H2>
<P>As the title says, this WMS is based on glideins. But what are <I><B>the
glideins</B></I>?<BR><BR>A glidein is, simply put, a properly
configured <A HREF="http://www.cs.wisc.edu/condor/manual/v7.0/3_1Introduction.html#SECTION00412000000000000000">Condor
Startd</A> submitted as a Grid job. <BR>Once the glidein starts on a
worker node, it will join the the specified Condor pool, making the
obtained Grid-batch slot a slot in the Condor pool. At this point, a
regular Condor job can start there as if was a dedicated resource.
See the picture below for a schematic overview.<BR><IMG SRC="images/glideins.png" NAME="graphics1" ALIGN=BOTTOM BORDER=0><BR>Condor
glideins are a convenient way to expand a Condor pool. Apart from the
task of submitting new glideins as needed, everything else&nbsp;stays
the same as in a dedicated pool.</P>
</div>


<div class="section">
<H2><A NAME="overview"></A>WMS Overview</H2>
<P>The glidein based WMS is made of two pieces:</P>
<ul>
	<li><b>One or more glidein factories:</b>
	The glidein factories are the one that know about available Grid
	sites and know how to submit glideins to them.</li>
	<li><b>One or more VO frontends:</b>
	The VO frontends are the ones that know about the VO job
	specifics and know how many and what kind of glideins are needed.</li>
</ul>
<P>The two pieces communicate via a common Condor Collector; see the
image below for a schematic view.<BR><IMG SRC="images/overview.png" NAME="graphics2" ALIGN=BOTTOM BORDER=0><BR>A
single WMS (identified by the Condor Collector) can serve multiple
frontends via multiple factories. It is a truly many-to-many system.
However, the current implementation does not support prioritization
between different frontends, so it is best to have only one frontend;
multiple factories will instead work as desired.<BR><BR>More details
can be found on the <A HREF="factory/index.html">Glidein Factory page</A>,
and on the <A HREF="frontend/index.html">VO Frontend page</A>. </p>
</div>


<div class="section">
<H2><A NAME="classads"></A>Data exchange overview</H2>
<P>In the previous section we described the general architecture of
the WMS. Let now have a look at the type of information that the two
pieces publish.</P>
<H3><A NAME="factory_classads"></A>The Glidein&nbsp;Factory Class-Ad</H3>
<P>A&nbsp;factory publishes one class-ad per glidein entry. The
class-ad contains 
</P>
<UL>
	<LI>the name of the glidein (and the factory),
	<LI>the attributes that describe the glidein,
	<LI>the list of parameters that the glidein accepts. All the
	parameters have also default values associated with them, in
	case a frontend does not redefine them, and
	<LI>the (optional) public key algorithm, ID and value, together with the
	    supported symmetric algorithms, that the frontend can use
            to push back encrypted values.
	<LI>Plus a list of monitoring values (like how many glideins are
	already in the queues, etc.) 
</UL>
<P>Look at the picture below for a generic description.<BR><BR><IMG SRC="images/factory_publish.png" NAME="graphics3" ALIGN=BOTTOM BORDER=0><BR><BR>Please
notice that the glidein attributes can be completely arbitrary; the
only predefined attributes are the glidein and factory name, plus the
convention that anything that starts with <FONT FACE="monospace"><B>GlideinParam</B></FONT>
is a parameter and anything that starts with <FONT FACE="monospace"><B>GlideinMonitor</B></FONT>
is a monitoring attribute.<BR><BR>Once the&nbsp;factory starts
serving frontends, it will publish also another ClassAd for every
frontend served. This ClassAd contains only monitoring information,
and is not used by the glideinWMS itself.<BR>Find below a graphical
representation of these ClassAds.<BR><IMG SRC="images/factory_client_publish.png" NAME="graphics4" ALIGN=BOTTOM BORDER=0></P>
<H3><A NAME="frontend_classads"></A>The VO Frontend Class-Ad</H3>
<P>A VO frontend will obtain the list all available glideins and
select the ones that fit its needs, based on the published
attributes. For each fitting glidein, a frontend class-ad will be
published. Such a class-ad will contain 
</P>
<UL>
	<LI>the name of the frontend and a request ID,
	<LI>the desired glidein name,
	<LI>the (optional) URL and signatures for the frontend specific scripts and data,
	<LI>the desired rate and limits of glidein submissions,
	<LI>the glidein parameters (in clear),and
	<LI>the (optional) factory public key ID used, together with
	<UL>
	  <LI>the symmetric encryption algorithm and key,
	  <LI>the encrypted identity, and
	  <LI>the encrypted parameters.
	</UL>
	<LI>Plus a list of monitoring values (like how many jobs are
	currently running, etc.) 
</UL>
<P>If encryption is used, the the encrypted identity must must match the AuthenticatedIdentity attribute inserted by the condor collector <b>(needs Condor version 7.3.1 or better)</b></P>

<P>Have a look at the picture below for a generic description.<BR><IMG SRC="images/frontend_publish.png" NAME="graphics5" ALIGN=BOTTOM BORDER=0></P>
<P>The most important parameters that the VO fronted sends to the factory are:</P>
<UL>
      <LI>The address of the <A HREF="#pool_glidein">VO pool collector(s)</A> - <B>GLIDEIN_Collector</B>.</LI>
      <LI>The pilot proxies. If present, these are always encrypted. Three types of information are sent:
	<UL>
	  <LI>Number of proxies sent - <B>nr_x509_proxies</B></LI>
	  <LI>The proxy identifiers; given an identifier, the proxy DN must not change between updates. - <B>x509_proxy_0_identifier</B> ... <B>x509_proxy_N_identifier</B></LI>
	  <LI>The security classes; proxies within the same class may have access to one another - <B>x509_proxy_0_security_class</B> ... <B>x509_proxy_N_security_class</B></LI>
	  <LI>The proxies themselves - <B>x509_proxy_0</B> ... <B>x509_proxy_N</B></LI>
        </UL></LI>
      <LI>The security name associated with the proxies - <B>SecurityName</B>. 
          The factory uses it for frontend whitelisting.
          If present, it is always encrypted.</LI> 
</UL>
<P>The picture below shows this in a graphics format.<BR>
   <IMG SRC="images/frontend_publish_params.png" NAME="graphics5b" ALIGN=BOTTOM BORDER=0></P>
<P>In the current implementation, the only glidein rate setting parameters
supported are <FONT FACE="monospace"><B>ReqIdleGlideins</B></FONT>,
that tells the factory how many idle glideins to keep in the queue at
any given time, and <FONT FACE="monospace"><B>ReqMaxRunningGlideins</B></FONT>,
that tells the factory to stop submitting new glideins when the
number of running glidiens reaces that level.
Future versions may contain more sophisticated
controls, like the maximum number of glideins to keep in the queue or
the maximum rate at which the glideins should be submitted.</P>
<H2><A NAME="implementation"></A>Implementation details</H2>
<P>Due to the amount of material available, the documentation is
being kept on the <A HREF="factory/index.html#implementation">Glidein
	Factory page</A>, and 
on the <A HREF="frontend/index.html#implementation">VO
	Frontend page</A>. 
</div>

<div class="section">
<H2><A NAME="condor"></A>The Condor pool</H2>
<P>To make a working Glidein-based WMS, you will need to install one
or more Condor pools:</P>
<UL>
	<LI><A HREF="#pool_WMS">WMS pool for exchanging messages between the
	factory and the frontends</A> 
	<LI><A HREF="#pool_glidein">User pool for each VO frontend</A> 
</UL>
<P>If you want, you can merge several of them together, but at least
logically, they are separate, and I would strongly suggest to keep
them separate unless you have just a small system.<BR><BR>Installing
and properly configuring a Condor pool is (unfortunately) a complex
process, and this manual will not attempt to describe all the glory
details. In this manual, it is assumed you have installed a Condor
pool already (see <A HREF="http://www.cs.wisc.edu/condor/">http://www.cs.wisc.edu/condor/</A>
for more information) and only the WMS specific options&nbsp;are
discussed.<BR><BR>Most configuration changes needed by the
Glidein-based WMS regard security; you definitely don't want just
anybody to mess with you pool!</P>
<H3><A NAME="pool_WMS"></A>The WMS pool</H3>
<P>The <A HREF="images/overview.png" TARGET="_blank">WMS pool</A> can use
any authentication mechanism you prefer; GSI (i.e. x509), Kerberos,
etc., all work fine for this purpose. There is also nothing to hide,
so encryption can be turned off. However, you do want to make sure
that the information is not tampered with, so you should enable the
integrity checks!<BR><BR>If you happen to know the IP addresses of
all the factories and all the frontends, it is also good practice to
limit the ability to submit new requests to only those nodes ( +
obviously the Collector machine).<BR><BR>Here is a prototype of the
security config: 
</P>
<PRE>SEC_DEFAULT_AUTHENTICATION = REQUIRED
SEC_DEFAULT_AUTHENTICATION_METHODS = &lt;Your choice here&gt;
SEC_DEFAULT_INTEGRITY = REQUIRED
HOSTALLOW_WRITE = machine1,machine2, ... ,machineN</PRE><P>
For more information about GSI, look at the configuration of the
<A HREF="#pool_glidein">glidein (user) pool</A>. For all other kinds,
please follow the instructions in the <A HREF="http://www.cs.wisc.edu/condor/manual/">Condor
manual</A>.<BR><BR>To ease monitoring and debugging, it is also
useful to allow unauthenticated read of the information; as said
before, there is nothing to hide. However, <B>be sure you enable this
only for the Collector</B>, and require the factory and the frontend
to authenticate at all times, since this is needed for the integrity
checks to work. <BR><BR>The lines to add, on the Collector machine,
are:</P>
<PRE>SEC_READ_AUTHENTICATION = OPTIONAL
SEC_CLIENT_AUTHENTICATION = OPTIONAL
SEC_READ_INTEGRITY = OPTIONAL
SEC_CLIENT_INTEGRITY = OPTIONAL</PRE><P>
Last, please notice that there is no need for a Negotiator in this
pool. All the matching is done by the factory and frontend software
itself. (An no need for Startds either.)</P>
<H3><A NAME="pool_glidein"></A>The glidein (user) pool</H3>
<P>The <A HREF="images/glideins.png" TARGET="_blank">glidein pool</A> relies
heavily on GSI, also known as x509, authentication. The reason for
this is due to the nature of glideins; the Condor Startd is a Grid
job. And thus have&nbsp;a x509 proxy available at startup.<BR>So the
glidein Condor pool must be set up to support at least GSI; other
methods can be used too, to support your local user job submission
policies.<BR><BR>Regarding other security features, integrity checks
should be enabled and encryption should be left as an option for the
transfer of sensitive information in user jobs.<BR><BR>Here is a
prototype of the security config: 
</P>
<PRE>SEC_DEFAULT_AUTHENTICATION = REQUIRED
SEC_DEFAULT_AUTHENTICATION_METHODS = &lt;local methods&gt;, GSI
SEC_DEFAULT_INTEGRITY = REQUIRED
SEC_DEFAULT_ENCRYPTION = OPTIONAL</PRE><P>
The GSI authentication needs some other parameters to be enabled,
too. See the <A HREF="http://www.cs.wisc.edu/condor/manual/v7.0/3_6Security.html#SECTION00463100000000000000">Condor
manual</A> for the full details.<BR><BR>First of all, you must tell
Condor what kind of proxies you will trust; i.e. you must provide it
with the public keys of all the trusted Certification Authorities
(CAs).<BR><BR>Next, you have to tell condor how it will authenticate
with the other parties. You can use either a host certificate/key
pair or a regular proxy. The glidein will always use a proxy, but all
the other Condor daemons (Collector, Negotiator and Schedd) can use a
host certificate if they are running as root and the machine has the
host certificates installed.&nbsp; Please note that the two methods
are equivalent, as Condor will extract, as needed, a proxy from the
certificate using the provided key.<BR><BR>Last but not least, you
must specify who do you trust. A sensitive sysadmin will want only
the known DNs (Distinguished Names, i.e. the text representation of
the proxy identity) to be allowed to impersonate Condor daemons.
There are two places where this has to be set:</P>
<UL>
	<LI><P>The first one is the so called Grid Mapfile (<FONT FACE="monospace"><B>GRIDMAP</B></FONT>);
	it must list all the DNs Condor will trust. For example:</P>
	<PRE>[root@cmswmshead.fnal.gov] cat grid-mapfile 
&quot;/DC=org/DC=doegrids/OU=Robots/CN=FNAL CMSWMS Head&quot; condor1
&quot;/DC=org/DC=doegrids/OU=Robots/CN=FNAL CMSWMS Factory1&quot; condor2
&quot;/DC=org/DC=doegrids/OU=Robots/CN=FNAL CMSWMS Frontend1&quot; condor3</PRE><P>
	Recent condor versions provide also another, more flexible unified
	map file (<FONT FACE="monospace"><B>CERTIFICATE_MAPFILE</B></FONT>).
	It can be use instead of the grid mapfile, and map users from all
	supported authentication domains.<BR>For example:</P>
	<PRE>[root@cmswmshead.fnal.gov] cat condor_mapfile 
GSI &quot;/DC=org/DC=doegrids/OU=Robots/CN=FNAL CMSWMS Head&quot; condor1
GSI &quot;/DC=org/DC=doegrids/OU=Robots/CN=FNAL CMSWMS Factory1&quot; condor2
GSI &quot;/DC=org/DC=doegrids/OU=Robots/CN=FNAL CMSWMS Frontend1&quot; condor3
GSI (.*) anonymous
FS (.*) \1</PRE><P>
	If you use GSI just for the maintenance of the glidein (user) pool,
	it should list only the trusted DNs.<BR>Please notice that if you
	use GSI for authenticating your users, too, you need to list all of
	them in the map file. 
	<LI><P>The second place is a list of trusted daemon DNs
	(<FONT FACE="monospace"><B>GSI_DAEMON_NAME</B></FONT>). <BR>Please
	notice that all the trusted DNs need to be listed in <B>both places</B>.
		</P>
	<P><B>Note:</B> If you use gLExec with Condor, you also need to list
	all the users as trusted daemons. While suboptimal in security
	terms, it is a current (as of 7.0.0) Condor requirement. 
	</P>
</UL>
<P>A prototype of the above configuration is:</P>
<PRE>GSI_DAEMON_DIRECTORY = /opt/condor/certs
# Use a Proxy
GSI_DAEMON_PROXY = $(GSI_DAEMON_DIRECTORY)/x509_service_proxy
# Use a Certificate/Key pair
#GSI_DAEMON_CERT = $(GSI_DAEMON_DIRECTORY)/hostcert.pem
#GSI_DAEMON_KEY = $(GSI_DAEMON_DIRECTORY)/hostkey.pem
GRIDMAP=$(GSI_DAEMON_DIRECTORY)/grid-mapfile
GSI_DAEMON_NAME= /DC=org/DC=doegrids/OU=Robots/CN=FNAL CMSWMS Head,\
 /DC=org/DC=doegrids/OU=Robots/CN=FNAL CMSWMS Factory1,\
 /DC=org/DC=doegrids/OU=Robots/CN=FNAL CMSWMS Frontend1</PRE><P>
<BR>Last, to ease monitoring and debugging, it is also useful to
allow unauthenticated read of the information, unless you have strict
privacy requirements in your environment.<BR><BR>To enable it, add
the following lines:</P>
<PRE>SEC_READ_AUTHENTICATION = OPTIONAL
SEC_CLIENT_AUTHENTICATION = OPTIONAL
SEC_READ_INTEGRITY = OPTIONAL
SEC_CLIENT_INTEGRITY = OPTIONAL</PRE><P>
As of Condor version 7.1.3 condor also supports a more efficient
authentication mechanism between the condor_schedd/condor_shadow and
condor_startd/condor_starter. This method uses the match ClaimId as a
shared password for authentication between these daemons. Since using
a shared secret is much cheaper that using GSI authentication, this
should be used every time it is feasible.</P>
<p>
	To enable it, add the following lines:
</p>
<PRE>SEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION = True</PRE>
<p>
	Use this option for the schedd only; <B>do not</B> add this
	option to either the negotiator or collector as it will not work.
<P>
Obviously, this will only work with Condor versions 7.1.3 and above.
</P>
<P>Please note that you do not need to worry about glidein security
configuration at a global level; the <A HREF="factory/entry.html#security">glidein factory</A> will make sure the settings are correct in the glideins.
</P>
</div></div>
<p> <b>CVSROOT:</b> cvsuser@cdcvs.fnal.gov:/cvs/cd </p>
<p> <b>Packages:</b> glideinWMS </p>
<p> <b>glideinWMS Support:</b> glideinwms-support@fnal.gov</p>

</BODY>
</HTML>
