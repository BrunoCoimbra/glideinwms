<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
	<TITLE>Writing custom scripts</TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 3.0  (Linux)">
	<META NAME="CREATED" CONTENT="0;0">
	<META NAME="CHANGED" CONTENT="20081216;17195900">
	<META NAME="Info 1" CONTENT="">
	<META NAME="Info 2" CONTENT="">
	<META NAME="Info 3" CONTENT="">
	<META NAME="Info 4" CONTENT="">
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<H1>Writing custom scripts</H1>
<H2>Description</H2>
<P>This document describes how to write custom scripts to run in a
glidein. Glidein Factory administrators may want to write them to
implement features specific to their clients. Two examples are worker
node validation, and discovery and setup of VO-specific software.<BR><B>PS</B>:
The “scripts” can also be compiled binaries.</P>
<H2>Index</H2>
<UL>
	<LI><P><A HREF="#config">Script inclusion</A></P>
	<LI><P><A HREF="#api">Script API</A></P>
	<LI><P><A HREF="#glidein_config">The glidein configuration file</A></P>
	<LI><P><A HREF="#condor_vars">Condor vars file</A></P>
	<LI><P><A HREF="#order">Loading order</A></P>
	<LI><P><A HREF="#examples">Examples</A></P>
</UL>
<H2><A NAME="config"></A>Script inclusion</H2>
<P>A script is a file that was listed in the Glidein Factory
configuration file as being executable:</P>
<BLOCKQUOTE><FONT FACE="Courier, monospace">executable=”True”</FONT></BLOCKQUOTE>
<P>By default the files listed are non executable, so an
administrator needs explicitly list the executable ones.</P>
<H2><A NAME="api"></A>Script API</H2>
<P>A script is provided with exactly 2 arguments:</P>
<OL>
	<LI><P>the name of <A HREF="#glidein_config">the glidein
	configuration file</A></P>
	<LI><P>an entry id; this can be either <FONT FACE="Courier, monospace"><B>main</B></FONT>
	or the name of the entry point</P>
</OL>
<P>All other input comes from <A HREF="#glidein_config">the glidein
configuration file</A> that is used as a dashboard between different
scripts.</P>
<P>The script must return with exit code 0 if successful; a non-zero
return value will stop the execution of the glidein with a validation
error.</P>
<P>If the script provides any output to be used by other scripts, it
should write it <A HREF="#glidein_config">the glidein configuration
file</A>. If the values need to be published by the condor_startd or
visible by the user jobs, the condor vars file should also be
modified.</P>
<H2><A NAME="glidein_config"></A>The glidein configuration file</H2>
<P>The glidein configuration file acts as a dashboard between
different scripts.</P>
<P>The glidein configuration file is a simple ASCII file, with one
value per line; the first column represents the attribute name, while
the rest is the attribute value.<BR>If the value does not contain any
spaces, the easiest way to extract a value in bash is:</P>
<BLOCKQUOTE><I>attr_val</I><FONT FACE="Courier, monospace">=`grep
&quot;^$</FONT><I>attr_name</I> <FONT FACE="Courier, monospace">&quot;
</FONT>$<I>glidein_config</I> <FONT FACE="Courier, monospace">| awk
'{print $2}'`</FONT></BLOCKQUOTE>
<P><BR><BR>
</P>
<P>Several attributes are added by the default glidein scripts, the
most interesting being:</P>
<UL>
	<LI><P>ADD_CONFIG_LINE_SOURCE – Script that can be used to add new
	attributes to the glidein configuration file (see below).</P>
	<LI><P>GLIDEIN_Name – Name of the glidein branch</P>
	<LI><P>GLIDEIN_Entry_Name – name of the glidein entry point</P>
	<LI><P>TMP_DIR – The path to the temporary dir</P>
	<LI><P>PROXY_URL – The URL of the Web proxy</P>
</UL>
<P>All attributes of the glidein factory (both the common and the
entry specific) are also loaded into this file.</P>
<P><BR><BR>
</P>
<P>To write into the glidein configuration file, the best approach in
bash is to use the add_config_line support script. Just source the
provided script and use it. Here is an example:</P>
<BLOCKQUOTE><FONT FACE="Courier, monospace"># get the glidein
configuration file name<BR>glidein_config=$1</FONT></BLOCKQUOTE>
<BLOCKQUOTE><FONT FACE="Courier, monospace"># import add_config_line
function<BR>add_config_line_source=`grep '^ADD_CONFIG_LINE_SOURCE '
$glidein_config | awk '{print $2}'`<BR>source $add_config_line_source</FONT></BLOCKQUOTE>
<BLOCKQUOTE><FONT FACE="Courier, monospace"># add an
attributes<BR>add_config_line</FONT> <I>myattribute myvalue</I></BLOCKQUOTE>
<H2><A NAME="condor_vars"></A>Condor vars file</H2>
<P>The glideinWMS uses a so called <I>condor vars file</I> to decide
which attributes are going to be inserted into the condor
configuration file, which are going to be published by the glidein
condor_startd to the collector, and which attributes are going to be
put into the job environment.</P>
<P>The condor vars file can be found from <A HREF="#glidein_config">the
glidein configuration file</A> as</P>
<BLOCKQUOTE><FONT FACE="Courier, monospace">CONDOR_VARS_FILE</FONT></BLOCKQUOTE>
<P>It is an ASCII file, with one entry per row. Each non comment line
must have 7 columns. Each column has a specific meaning:</P>
<OL>
	<LI><P>Attribute name (will be extracted from <A HREF="#glidein_config">the
	glidein configuration file</A>)</P>
	<LI><P>Attribute type</P>
</OL>
<UL>
	<UL>
		<LI><P>I – integer</P>
		<LI><P>S – quoted string</P>
		<LI><P>C – unquoted string (i.e. Condor keyword or expression)</P>
	</UL>
</UL>
<OL START=3>
	<LI><P>Default value, use – if no default</P>
	<LI><P>Condor name, i.e. under which name should this attributed be
	known in the condor configuration</P>
	<LI><P>Is a value required for this attribute? <BR>Must be Y or N.
	If Y and the attribute is not defined, the glidein will fail.</P>
	<LI><P>Will condor_startd publish this attribute to the
	collector?<BR>Must be Y or N.</P>
	<LI><P>Will the attribute be exported to the user job environment?</P>
</OL>
<UL>
	<UL>
		<LI><P>- - Do not export</P>
		<LI><P>+ - Export using the original attribute name</P>
		<LI><P>@ - Export using the Condor name</P>
	</UL>
</UL>
<P>The glideinWMS defines several attributes in the default condor
var files</P>
<BLOCKQUOTE><FONT FACE="Courier, monospace">glideinWMS/creation/web_base/condor_vars.lst<BR>glideinWMS/creation/web_base/condor_vars.lst.entry</FONT></BLOCKQUOTE>
<P>Here below, you can see a short extract. For all the options, look
at your glideinWMS installation.</P>
<PRE># VarName               Type    Default         CondorName                      Req.    Export  UserName
#                       S=Quote - = No Default  + = VarName                             Condor  - = Do not export
#                                                                                               + = Use VarName
#                                                                                               @ = Use CondorName
#################################################################################################################
<FONT FACE="Courier, monospace">X509_USER_PROXY         C       -               GSI_DAEMON_PROXY                Y       N       -</FONT>
<FONT FACE="Courier, monospace">USE_MATCH_AUTH          C       -     SEC_ENABLE_MATCH_PASSWORD_AUTHENTICATION  N       N       -</FONT>
<FONT FACE="Courier, monospace">GLIDEIN_Factory         S       -               +                               Y       Y       @</FONT>
<FONT FACE="Courier, monospace">GLIDEIN_Name            S       -               +                               Y       Y       @</FONT>
<FONT FACE="Courier, monospace">GLIDEIN_Collector       C       -               HEAD_NODE                       Y       N       -</FONT>
<FONT FACE="Courier, monospace">GLIDEIN_Expose_Grid_Env C       False     JOB_INHERITS_STARTER_ENVIRONMENT      N       Y       +</FONT>
<FONT FACE="Courier, monospace">TMP_DIR                 S       -               GLIDEIN_Tmp_Dir                 Y       Y       @</FONT>
<FONT FACE="Courier, monospace">CONDORG_CLUSTER         I       -               GLIDEIN_ClusterId               Y       Y       @</FONT>
<FONT FACE="Courier, monospace">CONDORG_SUBCLUSTER      I       -               GLIDEIN_ProcId                  Y       Y       @</FONT>
<FONT FACE="Courier, monospace">CONDORG_SCHEDD          S       -               GLIDEIN_Schedd                  Y       Y       @</FONT>
<FONT FACE="Courier, monospace">SEC_DEFAULT_ENCRYPTION  C       OPTIONAL        +                               N       N       -</FONT>
<FONT FACE="Courier, monospace">SEC_DEFAULT_INTEGRITY   C       REQUIRED        +                               N       N       -</FONT>
<FONT FACE="Courier, monospace">MAX_MASTER_LOG          I       1000000         +                               N       N       -</FONT>
<FONT FACE="Courier, monospace">MAX_STARTD_LOG          I       10000000        +                               N       N       -</FONT></PRE><H2>
<A NAME="order"></A>Loading order</H2>
<P>Scripts are loaded and executed one at a time. There are six
distinct stages involved:</P>
<OL>
	<LI><P>Global attributes are loaded and global system scripts
	executed.</P>
	<LI><P>The user provided global files are loaded and user scripts
	are executed (i.e. all the ones that have the default
	<FONT FACE="Courier, monospace">after_entry=”False”</FONT>)</P>
	<LI><P>The entry specific attributes are loaded and entry specific
	system scripts executed.</P>
	<LI><P>The user provided entry specific files are loaded and entry
	specific user scripts are executed.</P>
	<LI><P>The after_entry user provided global files are loaded and
	after_entry user scripts are executed (i.e. all the ones that have
	set <FONT FACE="Courier, monospace">after_entry=”True”</FONT>)</P>
	<LI><P>Final global system scripts executed and the Condor daemons
	are launched.</P>
</OL>
<P>The Glidein Factory configuration allows an administrator to
specify the files/scripts mentioned in points 2, 4 and 5. <BR>The
files/scripts are loaded/executed in the order in which they are
specified in the configuration file.</P>
<H2><A NAME="examples"></A>Examples</H2>
<P>The above documentation is hopefully providing enough information
to write the scripts that will customize the glideins to your needs.
Below are a few examples you can use as templates.</P>
<H3>Test that a certain library exists</H3>
<PRE>#!/bin/sh

function warn {
 echo `date` $@ 1&gt;&amp;2
}

if [ -z “/usr/lib/libcrypto.so.0.9.8” ]; then
  warn “Crypto library not found!\n” 
  exit 1
fi
echo “Crypto library found”
</PRE><H3>
Find, test and advertise a software distribution</H3>
<PRE>#!/bin/sh

glidein_config=&quot;$1&quot;

function warn {
 echo `date` $@ 1&gt;&amp;2
}

###############
# Get the data

if [ -f &quot;$VO_SW_DIR/setup.sh&quot; ]; then
   source &quot;$VO_SW_DIR/setup.sh&quot;
else
   warn &quot;SW setup.sh not found!\n&quot;
   exit 1
fi

tmpname=$PWD/installed_software_tmp_$$.tmp
software_list&gt; $tmpname

##################
# Format the data

sw_list=`cat $tmpname | awk '{if (length(a)!=0) {a=a &quot;,&quot; $0} else {a=$0}}END{print a}'`

if [ -z &quot;$sw_list&quot; ]; then
  warn &quot;No SW found!&quot;
  exit 1
fi

#################
# Export the data

echo &quot;############ software ##############&quot; &gt;&gt; &quot;$glidein_config&quot;
echo &quot;GLIDEIN_SW_LIST $sw_list&quot; &gt;&gt; &quot;$glidein_config&quot;
echo &quot;########## end CMS software ############&quot; &gt;&gt; &quot;$glidein_config&quot;

# One has to tell the condor_startup to publish the data
condor_vars_file=`grep -i &quot;^CONDOR_VARS_FILE &quot; $glidein_config | awk '{print $2}'`
echo &quot;############ software ##############&quot; &gt;&gt; &quot;$condor_vars_file&quot;
echo &quot;GLIDEIN_SW_LIST S - + Y Y +&quot; &gt;&gt; &quot;$condor_vars_file&quot;
echo &quot;########## end software ############&quot; &gt;&gt; &quot;$condor_vars_file&quot;
</PRE><H3>
Change an existing value based on conditions found</H3>
<PRE>#!/bin/bash

glidein_config=$1
entry_dir=$2

function warn {
 echo `date` $@
}

# import add_config_line function, will use glidein_config
add_config_line_source=`grep '^ADD_CONFIG_LINE_SOURCE ' $glidein_config | awk '{print $2}'`
source $add_config_line_source

vo_scalability=`grep '^VO_SCALABILITY ' $glidein_config | awk '{print $2}'`

if [ -z “$vo_scalability” ]; then
  # set a reasonable default
  vo_scalability=5000
fi

tot_mem=`grep MemTotal /proc/meminfo |awk '{print $2}'`
if [ “$tot_mem” -lt 500000 ]; then
  if [ “$entry_dir” == “main” ]; then
    # all glideins need to scale down if low on memory
    let vo_scalability=vo_scalability/2
  elif [ “$entry_dir” == “florida23” ]; then
    # but florida23 can use a little more
    let vo_scalability=vo_scalability*5/4
  fi

  # write it back
  add_config_line VO_SCALABILITY $vo_scalability
fi 
</PRE><P>
<BR><BR>
</P>
<TABLE WIDTH=100% BORDER=0 CELLPADDING=2 CELLSPACING=2>
	<TR VALIGN=TOP>
		<TD>
			<H2 ALIGN=LEFT>Repository</H2>
			<H3 ALIGN=LEFT>CVSROOT</H3>
			<P ALIGN=LEFT>cvsuser@cdcvs.fnal.gov:/cvs/cd</P>
			<H2 ALIGN=LEFT>Package(s)</H2>
			<P ALIGN=LEFT>glideinWMS/creation</P>
		</TD>
		<TD>
			<H2 ALIGN=LEFT>Author(s)</H2>
			<P ALIGN=LEFT>Igor Sfiligoi (Fermilab Computing Division)</P>
		</TD>
	</TR>
</TABLE>
<P><BR><BR>
</P>
</BODY>
</HTML>